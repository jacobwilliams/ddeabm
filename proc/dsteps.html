<!-- -*- mode: jinja2 -*- -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="Modern Fortran Implementation of the DDEABM Adams-Bashforth-Moulton ODE Solver">
    <meta name="author" content="Jacob Williams" >
    <link rel="icon" href="../favicon.png">

    <title>dsteps &ndash; ddeabm</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
      <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>
  </head>

  <body>

    <!-- Fixed navbar -->
    <div class="container-fluid mb-sm-4 mb-xl-2">
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
          <a class="navbar-brand" href="../index.html">ddeabm </a>
          <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar"
                  aria-expanded="false" aria-controls="navbar" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon">
          </button>

          <div id="navbar" class="navbar-collapse collapse">
            <ul class="navbar-nav">
                  <li class="nav-item">
                    <a class="nav-link" href="sourcefile/ddeabm_module.f90.html">Source File</a>
                  </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/modules.html">Modules</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/procedures.html">Procedures</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/absint.html">Abstract Interfaces</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/types.html">Derived Types</a>
                </li>
            </ul>
              <div class="d-flex align-items-end flex-grow-1">
                <form action="../search.html" role="search" class="ms-auto">
                  <input type="text" class="form-control" aria-label="Search" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
                </form>
              </div>
          </div><!--/.nav-collapse -->
        </div>
      </nav>
    </div>

    <div class="container">
  <div class="row">
    <h1>dsteps
      <small>Subroutine</small>
      
    </h1>
      <div class="container p-2 mb-4 bg-light border rounded-3">
    <div class="row align-items-center justify-content-between" id="info-bar">
      <div class="col">
        <ul class="list-inline" style="margin-bottom:0px;display:inline">

            <li class="list-inline-item" id="statements"><i class="fa fa-list-ol"></i>
              <a data-bs-toggle="tooltip"
                 data-bs-placement="bottom" data-html="true"
                 title="23.3% of total for procedures.">353 statements</a>
            </li>

            <li class="list-inline-item" id="source-file">
              <i class="fa fa-code"></i>
              <a href="../src/ddeabm_module.F90"> Source File</a>
            </li>
        </ul>
      </div>
      <div class="col">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb justify-content-end mb-0">
                <li class="breadcrumb-item"><a href='../sourcefile/ddeabm_module.f90.html'>ddeabm_module.F90</a></li>
                <li class="breadcrumb-item"><a href='../module/ddeabm_module.html'>ddeabm_module</a></li>
            <li class="breadcrumb-item active" aria-current="page">dsteps</li>
          </ol>
        </nav>
      </div>
    </div>
  </div>
  <script>
    $(function () {
    $('[data-bs-toggle="tooltip"]').tooltip()
    })
  </script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
      <div id="sidebar">
      <h3>Contents</h3>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    <div class="card card-primary">
      <div class="card-header text-left"><h3 class="card-title">Source Code</h3></div>
      <div class="list-group">
        <a class="list-group-item" href="../proc/dsteps.html#src">dsteps</a>
      </div>
    </div>


  </div>

    </div>
    
    <div class="col-md-9" id='text'>
    <h2>private  subroutine dsteps(me, neqn, y, x, h, eps, wt, start, hold, k, kold, crash, phi, p, yp, psi, alpha, beta, sig, v, w, g, phase1, ns, nornd, ksteps, twou, fouru, xold, kprev, ivc, iv, kgi, gi)  
</h2>
    

    <p>integrate a system of first order ordinary differential equations one step.</p>
<p>subroutine dsteps is normally used indirectly through subroutine
   ddeabm.  because ddeabm suffices for most problems and is much
   easier to use, using it should be considered before using dsteps
   alone.</p>
<p>subroutine dsteps integrates a system of <code>neqn</code> first order ordinary
   differential equations one step, normally from <code>x</code> to <code>x+h</code>, using a
   modified divided difference form of the adams pece formulas.  local
   extrapolation is used to improve absolute stability and accuracy.
   the code adjusts its order and step size to control the local error
   per unit step in a generalized sense.  special devices are included
   to control roundoff error and to detect when the user is requesting
   too much accuracy.</p>
<h3>Input to dsteps</h3>
<p><strong>first call</strong></p>
<p>the user must provide storage in his calling program for all arrays
   in the call list, namely</p>
<div class="codehilite"><pre><span></span><code> dimension y(neqn),wt(neqn),phi(neqn,16),p(neqn),yp(neqn),psi(12),&amp;
           alpha(12),beta(12),sig(13),v(12),w(12),g(13),gi(11),iv(10)
</code></pre></div>

<p><strong>note</strong></p>
<p>the user must also declare <code>start</code>, <code>crash</code>, <code>phase1</code> and <code>nornd</code>
   logical variables and <code>df</code> an external subroutine, supply the
   subroutine <code>df(x,y,yp)</code> to evaluate
        <code>dy(i)/dx = yp(i) = df(x,y(1),y(2),...,y(neqn))</code>
   and initialize only the following parameters:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">neqn</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">equations</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">integrated</span>
<span class="w">    </span><span class="n">y</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">dependent</span><span class="w"> </span><span class="n">variables</span>
<span class="w">    </span><span class="n">x</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">independent</span><span class="w"> </span><span class="n">variable</span>
<span class="w">    </span><span class="n">h</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="n">nominal</span><span class="w"> </span><span class="n">step</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">indicating</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">integration</span>
<span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">maximum</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">step</span><span class="o">.</span><span class="w">  </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">variable</span>
<span class="w">    </span><span class="n">eps</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">tolerance</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">step</span><span class="o">.</span><span class="w">  </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">variable</span>
<span class="w">    </span><span class="n">wt</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">zero</span><span class="w"> </span><span class="n">weights</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">criterion</span>
<span class="w">    </span><span class="n">start</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="o">.</span><span class="n">true</span><span class="o">.</span>
<span class="w">    </span><span class="n">yp</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">initial</span><span class="w"> </span><span class="n">derivative</span><span class="w"> </span><span class="n">values</span>
<span class="w">    </span><span class="n">ksteps</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">ksteps</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">zero</span>
<span class="w">    </span><span class="n">twou</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="mf">2.</span><span class="o">*</span><span class="n">u</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">machine</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="n">roundoff</span><span class="w"> </span><span class="n">quantity</span>
<span class="w">    </span><span class="n">fouru</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="mf">4.</span><span class="o">*</span><span class="n">u</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">machine</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="n">roundoff</span><span class="w"> </span><span class="n">quantity</span>
</code></pre></div>

<p>define u to be the machine unit roundoff quantity by calling
   the function routine <code>d1mach</code>, <code>u = d1mach(4)</code>, or by
   computing <code>u</code> so that <code>u</code> is the smallest positive number such
   that <code>1.0+u &gt; 1.0</code>.</p>
<p>dsteps requires that the l2 norm of the vector with components
   local error(l)/wt(l)  be less than  eps  for a successful step.  the
   array  wt  allows the user to specify an error test appropriate
   for his problem.  for example,
      wt(l) = 1.0  specifies absolute error,
            = abs(y(l))  error relative to the most recent value of the
                 l-th component of the solution,
            = abs(yp(l))  error relative to the most recent value of
                 the l-th component of the derivative,
            = max(wt(l),abs(y(l)))  error relative to the largest
                 magnitude of l-th component obtained so far,
            = abs(y(l))*relerr/eps + abserr/eps  specifies a mixed
                 relative-absolute test where  relerr  is relative
                 error,  abserr  is absolute error and  eps =
                 max(relerr,abserr) .</p>
<h3>Subsequent calls</h3>
<p>subroutine dsteps is designed so that all information needed to
   continue the integration, including the step size <code>h</code> and the order
   <code>k</code>, is returned with each step.  with the exception of the step
   size, the error tolerance, and the weights, none of the parameters
   should be altered.  the array <code>wt</code> must be updated after each step
   to maintain relative error tests like those above.  normally the
   integration is continued just beyond the desired endpoint and the
   solution interpolated there with subroutine <a href="dintp.html">dintp</a>.  if it is
   impossible to integrate beyond the endpoint, the step size may be
   reduced to hit the endpoint since the code will not take a step
   larger than the <code>h</code> input.  changing the direction of integration,
   i.e., the sign of <code>h</code>, requires the user set <code>start = .true.</code> before
   calling dsteps again.  this is the only situation in which <code>start</code>
   should be altered.</p>
<h3>Output from dsteps</h3>
<p><strong>successful step</strong></p>
<p>the subroutine returns after each successful step with <code>start</code> and
   <code>crash</code> set .false. .  <code>x</code> represents the independent variable
   advanced one step of length <code>hold</code> from its value on input and <code>y</code>
   the solution vector at the new value of <code>x</code>.  all other parameters
   represent information corresponding to the new <code>x</code> needed to
   continue the integration.</p>
<p><strong>unsuccessful step</strong></p>
<p>when the error tolerance is too small for the machine precision,
   the subroutine returns without taking a step and <code>crash = .true.</code>.
   an appropriate step size and error tolerance for continuing are
   estimated and all other information is restored as upon input
   before returning.  to continue with the larger tolerance, the user
   just calls the code again.  a restart is neither required nor
   desirable.</p>
<h3>References</h3>
<ul>
<li>L. F. Shampine, M. K. Gordon, "Solving ordinary differential equations with ODE, STEP, and INTERP",
     Report SLA-73-1060,
     Sandia Laboratories, 1973.</li>
<li>L. F. Shampine, M. K. Gordon, "Computer solution of ordinary differential equations, the initial value problem",
     W. H. Freeman and Company, 1975.</li>
</ul>
<h3>History</h3>
<ul>
<li>740101  date written --
     shampine, l. f., (snla)
     gordon, m. k., (snla)
     modified by h.a. watts</li>
<li>890531  changed all specific intrinsics to generic.  (wrb)</li>
<li>890831  modified array declarations.  (wrb)</li>
<li>890831  revision date from version 3.2</li>
<li>891214  prologue converted to version 4.0 format.  (bab)</li>
<li>920501  reformatted the references section.  (wrb)</li>
<li>December, 2015 : Refactored this routine (jw)</li>
<li>January, 2017 : Added options for initial step mode (jw)</li>
</ul>

    <h3>Type Bound</h3>
    <p><a href='../type/ddeabm_class.html'>ddeabm_class</a></p>

    <h3>Arguments</h3>
        <table class="table table-striped varlist">
    <thead>
      <tr>
        <th scope="col">Type</th>
<th scope="col">Intent</th><th scope="col">Optional</th>        <th scope="col">Attributes</th>
        <th scope="col"></th>
        <th scope="col">Name</th>
        <th scope="col"></th>
    </thead>
    <tbody>
        <tr>
            <td>
              <span class="anchor" id="variable-me~20"></span>
              class(<a href='../type/ddeabm_class.html'>ddeabm_class</a>),
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>me</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-neqn~2"></span>
              integer,
            </td>
<td>intent(in)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>neqn</strong></td>
            <td>
                <p>number of equations to be integrated</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-y~8"></span>
              real(kind=wp),
            </td>
<td>intent(inout),</td>
              <td></td>            <td>
              dimension(neqn)
            </td>
            <td>::</td>
            <td><strong>y</strong></td>
            <td>
                <p>solution vector at x</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-x~8"></span>
              real(kind=wp),
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>x</strong></td>
            <td>
                <p>independent variable</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-h~5"></span>
              real(kind=wp),
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>h</strong></td>
            <td>
                <p>appropriate step size for next step.  normally determined by code</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-eps~3"></span>
              real(kind=wp),
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>eps</strong></td>
            <td>
                <p>local error tolerance</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-wt~3"></span>
              real(kind=wp),
            </td>
<td>intent(inout),</td>
              <td></td>            <td>
              dimension(neqn)
            </td>
            <td>::</td>
            <td><strong>wt</strong></td>
            <td>
                <p>vector of weights for error criterion</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-start~3"></span>
              logical,
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>start</strong></td>
            <td>
                <p>logical variable set .true. for first step, .false. otherwise</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-hold~3"></span>
              real(kind=wp),
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>hold</strong></td>
            <td>
                <p>step size used for last successful step</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-k~4"></span>
              integer,
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>k</strong></td>
            <td>
                <p>appropriate order for next step (determined by code)</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-kold~4"></span>
              integer,
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>kold</strong></td>
            <td>
                <p>order used for last successful step</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-crash~2"></span>
              logical,
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>crash</strong></td>
            <td>
                <p>logical variable set .true. when no step can be taken, .false. otherwise.</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-phi~4"></span>
              real(kind=wp),
            </td>
<td>intent(inout),</td>
              <td></td>            <td>
              dimension(neqn,16)
            </td>
            <td>::</td>
            <td><strong>phi</strong></td>
            <td>
                <p>required for the interpolation subroutine <a href="dintp.html">dintp</a></p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-p~3"></span>
              real(kind=wp),
            </td>
<td>intent(inout),</td>
              <td></td>            <td>
              dimension(neqn)
            </td>
            <td>::</td>
            <td><strong>p</strong></td>
            <td>
                <p>required for the interpolation subroutine <a href="dintp.html">dintp</a></p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-yp~4"></span>
              real(kind=wp),
            </td>
<td>intent(inout),</td>
              <td></td>            <td>
              dimension(neqn)
            </td>
            <td>::</td>
            <td><strong>yp</strong></td>
            <td>
                <p>derivative of solution vector at x after successful step</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-psi~3"></span>
              real(kind=wp),
            </td>
<td>intent(inout),</td>
              <td></td>            <td>
              dimension(12)
            </td>
            <td>::</td>
            <td><strong>psi</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-alpha~4"></span>
              real(kind=wp),
            </td>
<td>intent(inout),</td>
              <td></td>            <td>
              dimension(12)
            </td>
            <td>::</td>
            <td><strong>alpha</strong></td>
            <td>
                <p>required for the interpolation subroutine <a href="dintp.html">dintp</a></p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-beta~3"></span>
              real(kind=wp),
            </td>
<td>intent(inout),</td>
              <td></td>            <td>
              dimension(12)
            </td>
            <td>::</td>
            <td><strong>beta</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-sig~3"></span>
              real(kind=wp),
            </td>
<td>intent(inout),</td>
              <td></td>            <td>
              dimension(13)
            </td>
            <td>::</td>
            <td><strong>sig</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-v~4"></span>
              real(kind=wp),
            </td>
<td>intent(inout),</td>
              <td></td>            <td>
              dimension(12)
            </td>
            <td>::</td>
            <td><strong>v</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-w~4"></span>
              real(kind=wp),
            </td>
<td>intent(inout),</td>
              <td></td>            <td>
              dimension(12)
            </td>
            <td>::</td>
            <td><strong>w</strong></td>
            <td>
                <p>required for the interpolation subroutine <a href="dintp.html">dintp</a></p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-g~10"></span>
              real(kind=wp),
            </td>
<td>intent(inout),</td>
              <td></td>            <td>
              dimension(13)
            </td>
            <td>::</td>
            <td><strong>g</strong></td>
            <td>
                <p>required for the interpolation subroutine <a href="dintp.html">dintp</a></p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-phase1~3"></span>
              logical,
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>phase1</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-ns~3"></span>
              integer,
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>ns</strong></td>
            <td>
                <p>number of dsteps taken with size h</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-nornd~3"></span>
              logical,
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>nornd</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-ksteps~3"></span>
              integer,
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>ksteps</strong></td>
            <td>
                <p>counter on attempted steps</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-twou~3"></span>
              real(kind=wp),
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>twou</strong></td>
            <td>
                <p>2.*u where u is machine unit roundoff quantity</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-fouru~3"></span>
              real(kind=wp),
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>fouru</strong></td>
            <td>
                <p>4.*u where u is machine unit roundoff quantity</p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-xold~3"></span>
              real(kind=wp),
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>xold</strong></td>
            <td>
                <p>required for the interpolation subroutine <a href="dintp.html">dintp</a></p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-kprev~3"></span>
              integer,
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>kprev</strong></td>
            <td>
                
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-ivc~4"></span>
              integer,
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>ivc</strong></td>
            <td>
                <p>required for the interpolation subroutine <a href="dintp.html">dintp</a></p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-iv~4"></span>
              integer,
            </td>
<td>intent(inout),</td>
              <td></td>            <td>
              dimension(10)
            </td>
            <td>::</td>
            <td><strong>iv</strong></td>
            <td>
                <p>required for the interpolation subroutine <a href="dintp.html">dintp</a></p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-kgi~4"></span>
              integer,
            </td>
<td>intent(inout)</td>
              <td></td>            <td>
              
            </td>
            <td>::</td>
            <td><strong>kgi</strong></td>
            <td>
                <p>required for the interpolation subroutine <a href="dintp.html">dintp</a></p>
            </td>
        </tr>
        <tr>
            <td>
              <span class="anchor" id="variable-gi~4"></span>
              real(kind=wp),
            </td>
<td>intent(inout),</td>
              <td></td>            <td>
              dimension(11)
            </td>
            <td>::</td>
            <td><strong>gi</strong></td>
            <td>
                <p>required for the interpolation subroutine <a href="dintp.html">dintp</a></p>
            </td>
        </tr>
    </tbody>
  </table>

    <br>
    <div class="card">
      <div class="card-header">
  <h3 class="card-title">Calls</h3>
      </div>
      <div class="card-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: proc~~dsteps~~CallsGraph Pages: 1 -->
<svg id="procdstepsCallsGraph" width="641pt" height="30pt"
 viewBox="0.00 0.00 641.00 29.86" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~dsteps~~CallsGraph" class="graph" transform="scale(1.07 1.07) rotate(0) translate(4 28)">
<title>proc~~dsteps~~CallsGraph</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-28 683,-28 683,4 -4,4"/>
<!-- proc~dsteps -->
<g id="proc~~dsteps~~CallsGraph_node1" class="node">
<title>proc~dsteps</title>
<polygon fill="none" stroke="black" points="230,-24 0,-24 0,0 230,0 230,-24"/>
<text text-anchor="middle" x="115" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">ddeabm_module::ddeabm_class%dsteps</text>
</g>
<!-- proc~dhstrt -->
<g id="proc~~dsteps~~CallsGraph_node2" class="node">
<title>proc~dhstrt</title>
<g id="a_proc~~dsteps~~CallsGraph_node2"><a xlink:href="../proc/dhstrt.html" xlink:title="ddeabm_module::ddeabm_class%dhstrt">
<polygon fill="#d9534f" stroke="#d9534f" points="492,-24 266,-24 266,0 492,0 492,-24"/>
<text text-anchor="middle" x="379" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ddeabm_module::ddeabm_class%dhstrt</text>
</a>
</g>
</g>
<!-- proc~dsteps&#45;&gt;proc~dhstrt -->
<g id="proc~~dsteps~~CallsGraph_edge1" class="edge">
<title>proc~dsteps&#45;&gt;proc~dhstrt</title>
<path fill="none" stroke="#000000" d="M230.15,-12C238.68,-12 247.3,-12 255.87,-12"/>
<polygon fill="#000000" stroke="#000000" points="255.9,-15.5 265.9,-12 255.9,-8.5 255.9,-15.5"/>
</g>
<!-- proc~dhvnrm -->
<g id="proc~~dsteps~~CallsGraph_node3" class="node">
<title>proc~dhvnrm</title>
<g id="a_proc~~dsteps~~CallsGraph_node3"><a xlink:href="../proc/dhvnrm.html" xlink:title="ddeabm_module::dhvnrm">
<polygon fill="#d94e8f" stroke="#d94e8f" points="679,-24 528,-24 528,0 679,0 679,-24"/>
<text text-anchor="middle" x="603.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ddeabm_module::dhvnrm</text>
</a>
</g>
</g>
<!-- proc~dhstrt&#45;&gt;proc~dhvnrm -->
<g id="proc~~dsteps~~CallsGraph_edge2" class="edge">
<title>proc~dhstrt&#45;&gt;proc~dhvnrm</title>
<path fill="none" stroke="#000000" d="M492.23,-12C500.83,-12 509.42,-12 517.8,-12"/>
<polygon fill="#000000" stroke="#000000" points="517.9,-15.5 527.9,-12 517.9,-8.5 517.9,-15.5"/>
</g>
</g>
</svg>
</div>                <script>
                  var panprocdstepsCallsGraph = svgPanZoom('#procdstepsCallsGraph',
                    {zoomEnabled: true, controlIconsEnabled: true, fit: true, center: true,}
                  );
                </script>          <div>
            <a type="button" class="graph-help" data-bs-toggle="modal" href="#CallsGraph-help-text">Help</a>
          </div>
          <div class="modal fade" id="CallsGraph-help-text" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
<p>Nodes of different colours represent the following: </p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="641pt" height="28pt"
 viewBox="0.00 0.00 641.00 27.51" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1.16 1.16) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-28 741.5,-28 741.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node">
<title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="70,-24 0,-24 0,0 70,0 70,-24"/>
<text text-anchor="middle" x="35" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node">
<title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="146,-24 88,-24 88,0 146,0 146,-24"/>
<text text-anchor="middle" x="117" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node">
<title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="225.5,-24 164.5,-24 164.5,0 225.5,0 225.5,-24"/>
<text text-anchor="middle" x="195" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Type Bound Procedure -->
<g id="node4" class="node">
<title>Type Bound Procedure</title>
<polygon fill="#a7506f" stroke="#a7506f" points="374,-24 244,-24 244,0 374,0 374,-24"/>
<text text-anchor="middle" x="309" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Type Bound Procedure</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node5" class="node">
<title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="537.5,-24 392.5,-24 392.5,0 537.5,0 537.5,-24"/>
<text text-anchor="middle" x="465" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node6" class="node">
<title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="614,-24 556,-24 556,0 614,0 614,-24"/>
<text text-anchor="middle" x="585" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node7" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="737.5,-24 632.5,-24 632.5,0 737.5,0 737.5,-24"/>
<text text-anchor="middle" x="685" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

<p>Solid arrows point from a procedure to one which it calls. Dashed 
arrows point from an interface to procedures which implement that interface.
This could include the module procedures in a generic interface or the
implementation in a submodule of an interface in a parent module.
</p>
 </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
  <h3 class="card-title">Called by</h3>
      </div>
      <div class="card-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: proc~~dsteps~~CalledByGraph Pages: 1 -->
<svg id="procdstepsCalledByGraph" width="641pt" height="59pt"
 viewBox="0.00 0.00 641.00 58.59" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~dsteps~~CalledByGraph" class="graph" transform="scale(1.98 1.98) rotate(0) translate(4 112)">
<title>proc~~dsteps~~CalledByGraph</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-112 1265,-112 1265,4 -4,4"/>
<!-- proc~dsteps -->
<g id="proc~~dsteps~~CalledByGraph_node1" class="node">
<title>proc~dsteps</title>
<polygon fill="none" stroke="black" points="1261,-66 1031,-66 1031,-42 1261,-42 1261,-66"/>
<text text-anchor="middle" x="1146" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50">ddeabm_module::ddeabm_class%dsteps</text>
</g>
<!-- proc~ddes -->
<g id="proc~~dsteps~~CalledByGraph_node2" class="node">
<title>proc~ddes</title>
<g id="a_proc~~dsteps~~CalledByGraph_node2"><a xlink:href="../proc/ddes.html" xlink:title="ddeabm_module::ddeabm_class%ddes">
<polygon fill="#d9534f" stroke="#d9534f" points="995,-66 774,-66 774,-42 995,-42 995,-66"/>
<text text-anchor="middle" x="884.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ddeabm_module::ddeabm_class%ddes</text>
</a>
</g>
</g>
<!-- proc~ddes&#45;&gt;proc~dsteps -->
<g id="proc~~dsteps~~CalledByGraph_edge1" class="edge">
<title>proc~ddes&#45;&gt;proc~dsteps</title>
<path fill="none" stroke="#000000" d="M995.18,-54C1003.53,-54 1012.01,-54 1020.45,-54"/>
<polygon fill="#000000" stroke="#000000" points="1020.73,-57.5 1030.73,-54 1020.73,-50.5 1020.73,-57.5"/>
</g>
<!-- proc~ddeabm -->
<g id="proc~~dsteps~~CalledByGraph_node3" class="node">
<title>proc~ddeabm</title>
<g id="a_proc~~dsteps~~CalledByGraph_node3"><a xlink:href="../proc/ddeabm.html" xlink:title="ddeabm_module::ddeabm_class%ddeabm">
<polygon fill="#d9534f" stroke="#d9534f" points="738,-66 498,-66 498,-42 738,-42 738,-66"/>
<text text-anchor="middle" x="618" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ddeabm_module::ddeabm_class%ddeabm</text>
</a>
</g>
</g>
<!-- proc~ddeabm&#45;&gt;proc~ddes -->
<g id="proc~~dsteps~~CalledByGraph_edge2" class="edge">
<title>proc~ddeabm&#45;&gt;proc~ddes</title>
<path fill="none" stroke="#000000" d="M738.1,-54C746.67,-54 755.32,-54 763.9,-54"/>
<polygon fill="#000000" stroke="#000000" points="763.92,-57.5 773.92,-54 763.92,-50.5 763.92,-57.5"/>
</g>
<!-- proc~ddeabm_with_event_wrapper -->
<g id="proc~~dsteps~~CalledByGraph_node4" class="node">
<title>proc~ddeabm_with_event_wrapper</title>
<g id="a_proc~~dsteps~~CalledByGraph_node4"><a xlink:href="../proc/ddeabm_with_event_wrapper.html" xlink:title="ddeabm_module::ddeabm_with_event_class%ddeabm_with_event_wrapper">
<polygon fill="#d9534f" stroke="#d9534f" points="438,-108 24,-108 24,-84 438,-84 438,-108"/>
<text text-anchor="middle" x="231" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ddeabm_module::ddeabm_with_event_class%ddeabm_with_event_wrapper</text>
</a>
</g>
</g>
<!-- proc~ddeabm_with_event_wrapper&#45;&gt;proc~ddeabm -->
<g id="proc~~dsteps~~CalledByGraph_edge3" class="edge">
<title>proc~ddeabm_with_event_wrapper&#45;&gt;proc~ddeabm</title>
<path fill="none" stroke="#000000" d="M374.42,-83.97C403.42,-81.25 433.71,-78.21 462,-75 481.85,-72.75 503.09,-70.06 523.29,-67.37"/>
<polygon fill="#000000" stroke="#000000" points="523.98,-70.8 533.42,-66 523.05,-63.87 523.98,-70.8"/>
</g>
<!-- proc~ddeabm_with_event_wrapper_vec -->
<g id="proc~~dsteps~~CalledByGraph_node5" class="node">
<title>proc~ddeabm_with_event_wrapper_vec</title>
<g id="a_proc~~dsteps~~CalledByGraph_node5"><a xlink:href="../proc/ddeabm_with_event_wrapper_vec.html" xlink:title="ddeabm_module::ddeabm_with_event_class_vec%ddeabm_with_event_wrapper_vec">
<polygon fill="#d9534f" stroke="#d9534f" points="462,-66 0,-66 0,-42 462,-42 462,-66"/>
<text text-anchor="middle" x="231" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ddeabm_module::ddeabm_with_event_class_vec%ddeabm_with_event_wrapper_vec</text>
</a>
</g>
</g>
<!-- proc~ddeabm_with_event_wrapper_vec&#45;&gt;proc~ddeabm -->
<g id="proc~~dsteps~~CalledByGraph_edge4" class="edge">
<title>proc~ddeabm_with_event_wrapper_vec&#45;&gt;proc~ddeabm</title>
<path fill="none" stroke="#000000" d="M462.07,-54C470.75,-54 479.32,-54 487.71,-54"/>
<polygon fill="#000000" stroke="#000000" points="487.85,-57.5 497.85,-54 487.85,-50.5 487.85,-57.5"/>
</g>
<!-- proc~ddeabm_wrapper -->
<g id="proc~~dsteps~~CalledByGraph_node6" class="node">
<title>proc~ddeabm_wrapper</title>
<g id="a_proc~~dsteps~~CalledByGraph_node6"><a xlink:href="../proc/ddeabm_wrapper.html" xlink:title="ddeabm_module::ddeabm_class%ddeabm_wrapper">
<polygon fill="#d9534f" stroke="#d9534f" points="375.5,-24 86.5,-24 86.5,0 375.5,0 375.5,-24"/>
<text text-anchor="middle" x="231" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ddeabm_module::ddeabm_class%ddeabm_wrapper</text>
</a>
</g>
</g>
<!-- proc~ddeabm_wrapper&#45;&gt;proc~ddeabm -->
<g id="proc~~dsteps~~CalledByGraph_edge5" class="edge">
<title>proc~ddeabm_wrapper&#45;&gt;proc~ddeabm</title>
<path fill="none" stroke="#000000" d="M374.42,-24.03C403.42,-26.75 433.71,-29.79 462,-33 481.85,-35.25 503.09,-37.94 523.29,-40.63"/>
<polygon fill="#000000" stroke="#000000" points="523.05,-44.13 533.42,-42 523.98,-37.2 523.05,-44.13"/>
</g>
</g>
</svg>
</div>                <script>
                  var panprocdstepsCalledByGraph = svgPanZoom('#procdstepsCalledByGraph',
                    {zoomEnabled: true, controlIconsEnabled: true, fit: true, center: true,}
                  );
                </script>          <div>
            <a type="button" class="graph-help" data-bs-toggle="modal" href="#CalledByGraph-help-text">Help</a>
          </div>
          <div class="modal fade" id="CalledByGraph-help-text" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
<p>Nodes of different colours represent the following: </p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="641pt" height="28pt"
 viewBox="0.00 0.00 641.00 27.51" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1.16 1.16) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-28 741.5,-28 741.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node">
<title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="70,-24 0,-24 0,0 70,0 70,-24"/>
<text text-anchor="middle" x="35" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node">
<title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="146,-24 88,-24 88,0 146,0 146,-24"/>
<text text-anchor="middle" x="117" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node">
<title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="225.5,-24 164.5,-24 164.5,0 225.5,0 225.5,-24"/>
<text text-anchor="middle" x="195" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Type Bound Procedure -->
<g id="node4" class="node">
<title>Type Bound Procedure</title>
<polygon fill="#a7506f" stroke="#a7506f" points="374,-24 244,-24 244,0 374,0 374,-24"/>
<text text-anchor="middle" x="309" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Type Bound Procedure</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node5" class="node">
<title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="537.5,-24 392.5,-24 392.5,0 537.5,0 537.5,-24"/>
<text text-anchor="middle" x="465" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node6" class="node">
<title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="614,-24 556,-24 556,0 614,0 614,-24"/>
<text text-anchor="middle" x="585" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node7" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="737.5,-24 632.5,-24 632.5,0 737.5,0 737.5,-24"/>
<text text-anchor="middle" x="685" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

<p>Solid arrows point from a procedure to one which it calls. Dashed 
arrows point from an interface to procedures which implement that interface.
This could include the module procedures in a generic interface or the
implementation in a submodule of an interface in a parent module.
</p>
 </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <br>


    
    

    
    



    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl codehilite"><pre><span></span><span class="w">    </span><span class="k">subroutine </span><span class="n">dsteps</span><span class="w"> </span><span class="p">(</span><span class="n">me</span><span class="p">,</span><span class="w"> </span><span class="n">neqn</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">eps</span><span class="p">,</span><span class="w"> </span><span class="n">wt</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">hold</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,&amp;</span>
<span class="w">                       </span><span class="n">kold</span><span class="p">,</span><span class="w"> </span><span class="n">crash</span><span class="p">,</span><span class="w"> </span><span class="n">phi</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">yp</span><span class="p">,</span><span class="w"> </span><span class="n">psi</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="n">beta</span><span class="p">,</span><span class="w"> </span><span class="n">sig</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,&amp;</span>
<span class="w">                       </span><span class="n">phase1</span><span class="p">,</span><span class="w"> </span><span class="n">ns</span><span class="p">,</span><span class="w"> </span><span class="n">nornd</span><span class="p">,</span><span class="w"> </span><span class="n">ksteps</span><span class="p">,</span><span class="w"> </span><span class="n">twou</span><span class="p">,</span><span class="w"> </span><span class="n">fouru</span><span class="p">,</span><span class="w"> </span><span class="n">xold</span><span class="p">,</span><span class="w"> </span><span class="n">kprev</span><span class="p">,</span><span class="w"> </span><span class="n">ivc</span><span class="p">,</span><span class="w"> </span><span class="n">iv</span><span class="p">,&amp;</span>
<span class="w">                       </span><span class="n">kgi</span><span class="p">,</span><span class="w"> </span><span class="n">gi</span><span class="p">)</span>

<span class="w">    </span><span class="k">implicit none</span>

<span class="k">    class</span><span class="p">(</span><span class="n">ddeabm_class</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">me</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x</span><span class="w">      </span><span class="c">!! independent variable</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">h</span><span class="w">      </span><span class="c">!! appropriate step size for next step.  normally determined by code</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">eps</span><span class="w">    </span><span class="c">!! local error tolerance</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">hold</span><span class="w">   </span><span class="c">!! step size used for last successful step</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">k</span><span class="w">      </span><span class="c">!! appropriate order for next step (determined by code)</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">kold</span><span class="w">   </span><span class="c">!! order used for last successful step</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">ns</span><span class="w">     </span><span class="c">!! number of dsteps taken with size h</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">ksteps</span><span class="w"> </span><span class="c">!! counter on attempted steps</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">twou</span><span class="w">   </span><span class="c">!! 2.*u where u is machine unit roundoff quantity</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fouru</span><span class="w">  </span><span class="c">!! 4.*u where u is machine unit roundoff quantity</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">xold</span><span class="w">   </span><span class="c">!! required for the interpolation subroutine [[dintp]]</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">kprev</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">ivc</span><span class="w">    </span><span class="c">!! required for the interpolation subroutine [[dintp]]</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">kgi</span><span class="w">    </span><span class="c">!! required for the interpolation subroutine [[dintp]]</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">     </span><span class="kd">::</span><span class="w"> </span><span class="n">neqn</span><span class="w">   </span><span class="c">!! number of equations to be integrated</span>
<span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">start</span><span class="w">  </span><span class="c">!! logical variable set .true. for first step, .false. otherwise</span>
<span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">crash</span><span class="w">  </span><span class="c">!! logical variable set .true. when no step can be taken, .false. otherwise.</span>
<span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">phase1</span>
<span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">nornd</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">dimension</span><span class="p">(</span><span class="n">neqn</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">y</span><span class="w">      </span><span class="c">!! solution vector at x</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">dimension</span><span class="p">(</span><span class="n">neqn</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">wt</span><span class="w">     </span><span class="c">!! vector of weights for error criterion</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">dimension</span><span class="p">(</span><span class="n">neqn</span><span class="p">,</span><span class="mi">16</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">phi</span><span class="w"> </span><span class="c">!! required for the interpolation subroutine [[dintp]]</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">dimension</span><span class="p">(</span><span class="n">neqn</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">p</span><span class="w">      </span><span class="c">!! required for the interpolation subroutine [[dintp]]</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">dimension</span><span class="p">(</span><span class="n">neqn</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">yp</span><span class="w">     </span><span class="c">!! derivative of solution vector at x after successful step</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">dimension</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">psi</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">dimension</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">alpha</span><span class="w">    </span><span class="c">!! required for the interpolation subroutine [[dintp]]</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">dimension</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">beta</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">dimension</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">sig</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">dimension</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">v</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">dimension</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">w</span><span class="w">        </span><span class="c">!! required for the interpolation subroutine [[dintp]]</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">dimension</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">g</span><span class="w">        </span><span class="c">!! required for the interpolation subroutine [[dintp]]</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span><span class="k">dimension</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">gi</span><span class="w">       </span><span class="c">!! required for the interpolation subroutine [[dintp]]</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">iv</span><span class="w">      </span><span class="c">!! required for the interpolation subroutine [[dintp]]</span>

<span class="w">    </span><span class="kt">integer</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">ifail</span><span class="p">,</span><span class="w"> </span><span class="n">im1</span><span class="p">,</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="w"> </span><span class="n">iq</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">km1</span><span class="p">,</span><span class="w"> </span><span class="n">km2</span><span class="p">,</span><span class="w"> </span><span class="n">knew</span><span class="p">,&amp;</span>
<span class="w">                </span><span class="n">kp1</span><span class="p">,</span><span class="w"> </span><span class="n">kp2</span><span class="p">,</span><span class="w"> </span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">limit1</span><span class="p">,</span><span class="w"> </span><span class="n">limit2</span><span class="p">,</span><span class="w"> </span><span class="n">nsm2</span><span class="p">,&amp;</span>
<span class="w">                </span><span class="n">nsp1</span><span class="p">,</span><span class="w"> </span><span class="n">nsp2</span><span class="p">,</span><span class="w"> </span><span class="n">jv</span>
<span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">absh</span><span class="p">,</span><span class="w"> </span><span class="n">big</span><span class="p">,&amp;</span>
<span class="w">                </span><span class="n">erk</span><span class="p">,</span><span class="w"> </span><span class="n">erkm1</span><span class="p">,</span><span class="w"> </span><span class="n">erkm2</span><span class="p">,</span><span class="w"> </span><span class="n">erkp1</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">,&amp;</span>
<span class="w">                </span><span class="n">hnew</span><span class="p">,</span><span class="w"> </span><span class="n">p5eps</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,&amp;</span>
<span class="w">                </span><span class="n">reali</span><span class="p">,</span><span class="w"> </span><span class="n">realns</span><span class="p">,</span><span class="w"> </span><span class="n">rho</span><span class="p">,</span><span class="w"> </span><span class="n">round</span><span class="p">,</span><span class="w"> </span><span class="nb">sum</span><span class="p">,</span><span class="w"> </span><span class="n">tau</span><span class="p">,</span><span class="w"> </span><span class="n">temp1</span><span class="p">,&amp;</span>
<span class="w">                </span><span class="n">temp2</span><span class="p">,</span><span class="w"> </span><span class="n">temp3</span><span class="p">,</span><span class="w"> </span><span class="n">temp4</span><span class="p">,</span><span class="w"> </span><span class="n">temp5</span><span class="p">,</span><span class="w"> </span><span class="n">temp6</span><span class="p">,</span><span class="w"> </span><span class="n">u</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="c">!user-triggered error</span>

<span class="c">!       ***     begin block 0     ***</span>
<span class="c">!   check if step size or error tolerance is too small for machine</span>
<span class="c">!   precision.  if first step, initialize phi array and estimate a</span>
<span class="c">!   starting step size.</span>
<span class="c">!                   ***</span>

<span class="c">!   if step size is too small, determine an acceptable one</span>
<span class="w">      </span><span class="n">crash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">fouru</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">          </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sign</span><span class="p">(</span><span class="n">fouru</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">h</span><span class="p">)</span>
<span class="w">          </span><span class="k">return</span>
<span class="k">      end if</span>

<span class="k">      </span><span class="n">p5eps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5_wp</span><span class="o">*</span><span class="n">eps</span>

<span class="c">!   if error tolerance is too small, increase it to an acceptable value</span>
<span class="w">      </span><span class="n">round</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_wp</span>
<span class="w">      </span><span class="k">do </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">neqn</span>
<span class="w">        </span><span class="n">round</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">round</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">/</span><span class="n">wt</span><span class="p">(</span><span class="n">l</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
<span class="w">      </span><span class="k">end do</span>
<span class="k">      </span><span class="n">round</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">twou</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">round</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p5eps</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">round</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">          </span><span class="n">eps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0_wp</span><span class="o">*</span><span class="n">round</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0_wp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fouru</span><span class="p">)</span>
<span class="w">          </span><span class="k">return</span>
<span class="k">      end if</span>

<span class="k">      </span><span class="n">crash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">      </span><span class="n">g</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0_wp</span>
<span class="w">      </span><span class="n">g</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5_wp</span>
<span class="w">      </span><span class="n">sig</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0_wp</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="w">    </span><span class="c">!   initialize.  compute appropriate step size for first step</span>
<span class="w">    </span><span class="c">!   [There are three modes]</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">initial_step_mode</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            call </span><span class="n">me</span><span class="p">%</span><span class="n">df</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="c">! user-triggered error</span>
<span class="w">        </span><span class="k">end if</span>
<span class="k">        </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d1mach4</span>
<span class="w">        </span><span class="n">big</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="n">d1mach2</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">initial_step_mode</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="nb">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_wp</span>
<span class="w">        </span><span class="k">do </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">neqn</span>
<span class="w">            </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yp</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="w">            </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_wp</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">initial_step_mode</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="nb">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">yp</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">/</span><span class="n">wt</span><span class="p">(</span><span class="n">l</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
<span class="w">        </span><span class="k">end do</span>
<span class="k">        select case</span><span class="w"> </span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">initial_step_mode</span><span class="p">)</span>
<span class="w">        </span><span class="k">case</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">me</span><span class="p">%</span><span class="n">dhstrt</span><span class="p">(</span><span class="n">neqn</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="n">h</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">yp</span><span class="p">,</span><span class="n">wt</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">big</span><span class="p">,&amp;</span>
<span class="w">                           </span><span class="n">phi</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">phi</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">phi</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">phi</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="n">h</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="c">!user-triggered error</span>
<span class="w">            </span><span class="n">me</span><span class="p">%</span><span class="n">initial_step_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="c">! save it</span>
<span class="w">        </span><span class="k">case</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="w">            </span><span class="nb">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span>
<span class="w">            </span><span class="n">absh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">eps</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="mf">6.0_wp</span><span class="o">*</span><span class="nb">sum</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="n">absh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.25_wp</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">eps</span><span class="o">/</span><span class="nb">sum</span><span class="p">)</span>
<span class="w">            </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sign</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">absh</span><span class="p">,</span><span class="n">fouru</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span><span class="n">h</span><span class="p">)</span>
<span class="w">            </span><span class="n">me</span><span class="p">%</span><span class="n">initial_step_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="c">! save it</span>
<span class="w">        </span><span class="k">case</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="w">            </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sign</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">initial_step_size</span><span class="p">),</span><span class="n">h</span><span class="p">)</span><span class="w">   </span><span class="c">! user specified</span>
<span class="w">        </span><span class="k">case </span><span class="n">default</span>
<span class="w">            </span><span class="k">error stop</span><span class="w"> </span><span class="s1">&#39;invalid value for initial_step_mode&#39;</span>
<span class="w">        </span><span class="k">end select</span>

<span class="k">        </span><span class="n">hold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_wp</span>
<span class="w">        </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">kold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="n">kprev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">        </span><span class="n">phase1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">        </span><span class="n">nornd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p5eps</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">10</span><span class="mf">0.0_wp</span><span class="o">*</span><span class="n">round</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">nornd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">            </span><span class="k">do </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">neqn</span>
<span class="w">              </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_wp</span>
<span class="w">            </span><span class="k">end do</span>
<span class="k">        end if</span>

<span class="k">      end if</span>

<span class="k">      </span><span class="n">ifail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="c">!       ***     end block 0     ***</span>

<span class="c">!       ***     begin block 1     ***</span>
<span class="c">!   compute coefficients of formulas for this step.  avoid computing</span>
<span class="c">!   those quantities not changed when step size is not changed.</span>
<span class="c">!                   ***</span>

<span class="w"> </span><span class="mi">100</span><span class="w">  </span><span class="n">kp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
<span class="w">      </span><span class="n">kp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="o">+</span><span class="mi">2</span>
<span class="w">      </span><span class="n">km1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="o">-</span><span class="mi">1</span>
<span class="w">      </span><span class="n">km2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="o">-</span><span class="mi">2</span>

<span class="w">      </span><span class="c">! ns is the number of dsteps taken with size h, including the current</span>
<span class="w">      </span><span class="c">! one.  when k&lt;ns, no coefficients change</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">hold</span><span class="p">)</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ns</span><span class="o">&lt;=</span><span class="n">kold</span><span class="p">)</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ns</span><span class="o">+</span><span class="mi">1</span>
<span class="w">      </span><span class="n">nsp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ns</span><span class="o">+</span><span class="mi">1</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">ns</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="w">          </span><span class="c">! compute those components of alpha(*),beta(*),psi(*),sig(*) which</span>
<span class="w">          </span><span class="c">! are changed</span>

<span class="w">          </span><span class="n">beta</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0_wp</span>
<span class="w">          </span><span class="n">realns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ns</span>
<span class="w">          </span><span class="n">alpha</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0_wp</span><span class="o">/</span><span class="n">realns</span>
<span class="w">          </span><span class="n">temp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="o">*</span><span class="n">realns</span>
<span class="w">          </span><span class="n">sig</span><span class="p">(</span><span class="n">nsp1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0_wp</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nsp1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">              do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nsp1</span><span class="p">,</span><span class="n">k</span>
<span class="w">                </span><span class="n">im1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="o">-</span><span class="mi">1</span>
<span class="w">                </span><span class="n">temp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">psi</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span>
<span class="w">                </span><span class="n">psi</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp1</span>
<span class="w">                </span><span class="n">beta</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">beta</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span><span class="o">*</span><span class="n">psi</span><span class="p">(</span><span class="n">im1</span><span class="p">)</span><span class="o">/</span><span class="n">temp2</span>
<span class="w">                </span><span class="n">temp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h</span>
<span class="w">                </span><span class="n">alpha</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="o">/</span><span class="n">temp1</span>
<span class="w">                </span><span class="n">reali</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span>
<span class="w">                </span><span class="n">sig</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reali</span><span class="o">*</span><span class="n">alpha</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">sig</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">              </span><span class="k">end do</span>
<span class="k">          end if</span>
<span class="k">          </span><span class="n">psi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp1</span>

<span class="w">          </span><span class="c">! compute coefficients g(*)</span>
<span class="w">          </span><span class="c">!</span>
<span class="w">          </span><span class="c">! initialize v(*) and set w(*).</span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ns</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="w">              </span><span class="c">! if order was raised, update diagonal part of v(*)</span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">kprev</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                   if</span><span class="w"> </span><span class="p">(</span><span class="n">ivc</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                      </span><span class="n">jv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kp1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">iv</span><span class="p">(</span><span class="n">ivc</span><span class="p">)</span>
<span class="w">                      </span><span class="n">ivc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ivc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                   </span><span class="k">else</span>
<span class="k">                      </span><span class="n">jv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                      </span><span class="n">temp4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="o">*</span><span class="n">kp1</span>
<span class="w">                      </span><span class="n">v</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0_wp</span><span class="o">/</span><span class="n">temp4</span>
<span class="w">                      </span><span class="n">w</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">                      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                          </span><span class="n">kgi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                          </span><span class="n">gi</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="w">                      </span><span class="k">end if</span>
<span class="k">                   end if</span>
<span class="k">                   </span><span class="n">nsm2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ns</span><span class="o">-</span><span class="mi">2</span>
<span class="w">                   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nsm2</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">jv</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                       do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jv</span><span class="p">,</span><span class="n">nsm2</span>
<span class="w">                         </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="o">-</span><span class="n">j</span>
<span class="w">                         </span><span class="n">v</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">alpha</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">v</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="w">                         </span><span class="n">w</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">                       </span><span class="k">end do</span>
<span class="k">                       if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                           </span><span class="n">kgi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                           </span><span class="n">gi</span><span class="p">(</span><span class="n">kgi</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="w">                       </span><span class="k">end if</span>
<span class="k">                  end if</span>
<span class="k">              end if</span>

<span class="w">              </span><span class="c">!update v(*) and set w(*)</span>

<span class="w">              </span><span class="n">limit1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kp1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ns</span>
<span class="w">              </span><span class="n">temp5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alpha</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
<span class="w">              </span><span class="k">do </span><span class="n">iq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">limit1</span>
<span class="w">                </span><span class="n">v</span><span class="p">(</span><span class="n">iq</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="n">iq</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">temp5</span><span class="o">*</span><span class="n">v</span><span class="p">(</span><span class="n">iq</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="w">                </span><span class="n">w</span><span class="p">(</span><span class="n">iq</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="n">iq</span><span class="p">)</span>
<span class="w">              </span><span class="k">end do</span>
<span class="k">              </span><span class="n">g</span><span class="p">(</span><span class="n">nsp1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">limit1</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  </span><span class="n">kgi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ns</span>
<span class="w">                  </span><span class="n">gi</span><span class="p">(</span><span class="n">kgi</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="w">              </span><span class="k">end if</span>
<span class="k">              </span><span class="n">w</span><span class="p">(</span><span class="n">limit1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="n">limit1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kold</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  </span><span class="n">ivc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ivc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                  </span><span class="n">iv</span><span class="p">(</span><span class="n">ivc</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">limit1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span>
<span class="w">              </span><span class="k">end if</span>

<span class="k">          else</span>

<span class="k">              do </span><span class="n">iq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>
<span class="w">                </span><span class="n">temp3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iq</span><span class="o">*</span><span class="p">(</span><span class="n">iq</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="w">                </span><span class="n">v</span><span class="p">(</span><span class="n">iq</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0_wp</span><span class="o">/</span><span class="n">temp3</span>
<span class="w">                </span><span class="n">w</span><span class="p">(</span><span class="n">iq</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="n">iq</span><span class="p">)</span>
<span class="w">              </span><span class="k">end do</span>
<span class="k">              </span><span class="n">ivc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">              </span><span class="n">kgi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  </span><span class="n">kgi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                  </span><span class="n">gi</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="w">              </span><span class="k">end if</span>

<span class="k">          end if</span>

<span class="w">          </span><span class="c">! compute the g(*) in the work vector w(*)</span>

<span class="w">          </span><span class="n">nsp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span>
<span class="w">          </span><span class="n">kprev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kp1</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nsp2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">              do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nsp2</span><span class="p">,</span><span class="n">kp1</span>
<span class="w">                </span><span class="n">limit2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kp2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span>
<span class="w">                </span><span class="n">temp6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alpha</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">iq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">limit2</span>
<span class="w">                  </span><span class="n">w</span><span class="p">(</span><span class="n">iq</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="p">(</span><span class="n">iq</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">temp6</span><span class="o">*</span><span class="n">w</span><span class="p">(</span><span class="n">iq</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="w">                </span><span class="k">end do</span>
<span class="k">                </span><span class="n">g</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">              </span><span class="k">end do</span>
<span class="k">          end if</span>

<span class="k">      end if</span>

<span class="c">!       ***     end block 1     ***</span>

<span class="c">!       ***     begin block 2     ***</span>
<span class="c">!   predict a solution p(*), evaluate derivatives using predicted</span>
<span class="c">!   solution, estimate local error at order k and errors at orders k,</span>
<span class="c">!   k-1, k-2 as if constant step size were used.</span>
<span class="c">!                   ***</span>
<span class="c">!</span>
<span class="c">!   increment counter on attempted dsteps</span>
<span class="c">!</span>
<span class="w">      </span><span class="n">ksteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ksteps</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="c">!</span>
<span class="c">!   change phi to phi star</span>
<span class="c">!</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nsp1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">          do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nsp1</span><span class="p">,</span><span class="n">k</span>
<span class="w">            </span><span class="n">temp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">beta</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">            </span><span class="k">do </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">neqn</span>
<span class="w">              </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp1</span><span class="o">*</span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<span class="w">            </span><span class="k">end do</span>
<span class="k">          end do</span>
<span class="k">      end if</span>
<span class="c">!</span>
<span class="c">!   predict solution and differences</span>
<span class="c">!</span>
<span class="w">      </span><span class="k">do </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">neqn</span>
<span class="w">        </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">kp2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">kp1</span><span class="p">)</span>
<span class="w">        </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">kp1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_wp</span>
<span class="w">        </span><span class="n">p</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_wp</span>
<span class="w">      </span><span class="k">end do</span>
<span class="k">      do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>
<span class="w">        </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kp1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">j</span>
<span class="w">        </span><span class="n">ip1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
<span class="w">        </span><span class="n">temp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">        </span><span class="k">do </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">neqn</span>
<span class="w">          </span><span class="n">p</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">temp2</span><span class="o">*</span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<span class="w">          </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">ip1</span><span class="p">)</span>
<span class="w">        </span><span class="k">end do</span>
<span class="k">      end do</span>
<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">nornd</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">          </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h</span><span class="o">*</span><span class="n">p</span>
<span class="w">      </span><span class="k">else</span>
<span class="k">          do </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">neqn</span>
<span class="w">            </span><span class="n">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="o">*</span><span class="n">p</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
<span class="w">            </span><span class="n">p</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tau</span>
<span class="w">            </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="n">l</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tau</span>
<span class="w">          </span><span class="k">end do</span>
<span class="k">      end if</span>
<span class="k">      </span><span class="n">xold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span>
<span class="w">      </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h</span>
<span class="w">      </span><span class="n">absh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">me</span><span class="p">%</span><span class="n">df</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="c">! user-triggered error</span>
<span class="c">!</span>
<span class="c">!   estimate errors at orders k,k-1,k-2</span>
<span class="c">!</span>
<span class="w">      </span><span class="n">erkm2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_wp</span>
<span class="w">      </span><span class="n">erkm1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_wp</span>
<span class="w">      </span><span class="n">erk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_wp</span>
<span class="w">      </span><span class="k">do </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">neqn</span>
<span class="w">        </span><span class="n">temp3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0_wp</span><span class="o">/</span><span class="n">wt</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="w">        </span><span class="n">temp4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yp</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">km2</span><span class="o">&gt;=</span><span class="mf">0.0_wp</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">km2</span><span class="o">&gt;</span><span class="mf">0.0_wp</span><span class="p">)</span><span class="w"> </span><span class="n">erkm2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">erkm2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">km1</span><span class="p">)</span><span class="o">+</span><span class="n">temp4</span><span class="p">)</span><span class="o">*</span><span class="n">temp3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<span class="w">            </span><span class="n">erkm1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">erkm1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">temp4</span><span class="p">)</span><span class="o">*</span><span class="n">temp3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<span class="w">        </span><span class="k">end if</span>
<span class="k">        </span><span class="n">erk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">erk</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">temp4</span><span class="o">*</span><span class="n">temp3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<span class="w">      </span><span class="k">end do</span>
<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">km2</span><span class="o">&gt;=</span><span class="mf">0.0_wp</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">km2</span><span class="o">&gt;</span><span class="mf">0.0_wp</span><span class="p">)</span><span class="w"> </span><span class="n">erkm2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">absh</span><span class="o">*</span><span class="n">sig</span><span class="p">(</span><span class="n">km1</span><span class="p">)</span><span class="o">*</span><span class="n">me</span><span class="p">%</span><span class="n">gstr</span><span class="p">(</span><span class="n">km2</span><span class="p">)</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">erkm2</span><span class="p">)</span>
<span class="w">          </span><span class="n">erkm1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">absh</span><span class="o">*</span><span class="n">sig</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">me</span><span class="p">%</span><span class="n">gstr</span><span class="p">(</span><span class="n">km1</span><span class="p">)</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">erkm1</span><span class="p">)</span>
<span class="w">      </span><span class="k">end if</span>
<span class="k">      </span><span class="n">temp5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">absh</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">erk</span><span class="p">)</span>
<span class="w">      </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp5</span><span class="o">*</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">g</span><span class="p">(</span><span class="n">kp1</span><span class="p">))</span>
<span class="w">      </span><span class="n">erk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp5</span><span class="o">*</span><span class="n">sig</span><span class="p">(</span><span class="n">kp1</span><span class="p">)</span><span class="o">*</span><span class="n">me</span><span class="p">%</span><span class="n">gstr</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">      </span><span class="n">knew</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span>

<span class="w">      </span><span class="c">!   test if order should be lowered</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">km2</span><span class="o">&gt;</span><span class="mf">0.0_wp</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">erkm1</span><span class="p">,</span><span class="n">erkm2</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">erk</span><span class="p">)</span><span class="w"> </span><span class="n">knew</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">km1</span>
<span class="w">      </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">km2</span><span class="o">==</span><span class="mf">0.0_wp</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">erkm1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.5_wp</span><span class="o">*</span><span class="n">erk</span><span class="p">)</span><span class="w"> </span><span class="n">knew</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">km1</span>
<span class="w">      </span><span class="k">end if</span>
<span class="w">      </span><span class="c">!       ***     end block 2     ***</span>

<span class="w">    </span><span class="c">!test if step successful</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">eps</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="c">!       ***     begin block 3     ***</span>
<span class="c">!   the step is unsuccessful.  restore  x, phi(*,*), psi(*) .</span>
<span class="c">!   if third consecutive failure, set order to one.  if step fails more</span>
<span class="c">!   than three times, consider an optimal step size.  double error</span>
<span class="c">!   tolerance and return if estimated step size is too small for machine</span>
<span class="c">!   precision.</span>

<span class="c">!   restore x, phi(*,*) and psi(*)</span>

<span class="w">      </span><span class="n">phase1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">      </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xold</span>
<span class="w">      </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>
<span class="w">        </span><span class="n">temp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0_wp</span><span class="o">/</span><span class="n">beta</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">        </span><span class="n">ip1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
<span class="w">        </span><span class="k">do </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">neqn</span>
<span class="w">          </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp1</span><span class="o">*</span><span class="p">(</span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">ip1</span><span class="p">))</span>
<span class="w">        </span><span class="k">end do</span>
<span class="k">      end do</span>
<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">          do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="n">k</span>
<span class="w">            </span><span class="n">psi</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">psi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h</span>
<span class="w">          </span><span class="k">end do</span>
<span class="k">      end if</span>

<span class="c">!   on third failure, set order to one.  thereafter, use optimal step</span>
<span class="c">!   size</span>

<span class="w">      </span><span class="n">ifail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifail</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="n">temp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5_wp</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ifail</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.0_wp</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">ifail</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0_wp</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">p5eps</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.25_wp</span><span class="o">*</span><span class="n">erk</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">           </span><span class="n">temp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="n">p5eps</span><span class="o">/</span><span class="n">erk</span><span class="p">)</span>
<span class="w">          </span><span class="n">knew</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="k">end if</span>
<span class="k">      </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp2</span><span class="o">*</span><span class="n">h</span>
<span class="w">      </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">knew</span>
<span class="w">      </span><span class="n">ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">fouru</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mi">100</span>
<span class="w">      </span><span class="n">crash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">      </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sign</span><span class="p">(</span><span class="n">fouru</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">h</span><span class="p">)</span>
<span class="w">      </span><span class="n">eps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eps</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">eps</span>
<span class="w">      </span><span class="k">return</span>

<span class="k">    end if</span>
<span class="w">    </span><span class="c">!       ***     end block 3     ***</span>

<span class="c">!       ***     begin block 4     ***</span>
<span class="c">!   the step is successful.  correct the predicted solution, evaluate</span>
<span class="c">!   the derivatives using the corrected solution and update the</span>
<span class="c">!   differences.  determine best order and step size for next step.</span>

<span class="w">      </span><span class="n">kold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span>
<span class="w">      </span><span class="n">hold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span>

<span class="c">!   correct and evaluate</span>

<span class="w">      </span><span class="n">temp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="o">*</span><span class="n">g</span><span class="p">(</span><span class="n">kp1</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nornd</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">          do </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">neqn</span>
<span class="w">            </span><span class="n">temp3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="w">            </span><span class="n">y</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">temp1</span><span class="o">*</span><span class="p">(</span><span class="n">yp</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="w">            </span><span class="n">p</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp3</span>
<span class="w">          </span><span class="k">end do</span>
<span class="k">      else</span>
<span class="k">          do </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">neqn</span>
<span class="w">            </span><span class="n">temp3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="w">            </span><span class="n">rho</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp1</span><span class="o">*</span><span class="p">(</span><span class="n">yp</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
<span class="w">            </span><span class="n">y</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rho</span>
<span class="w">            </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="n">l</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rho</span>
<span class="w">            </span><span class="n">p</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp3</span>
<span class="w">          </span><span class="k">end do</span>
<span class="k">      end if</span>
<span class="k">     call </span><span class="n">me</span><span class="p">%</span><span class="n">df</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">yp</span><span class="p">)</span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">me</span><span class="p">%</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="c">! user-triggered error</span>

<span class="c">!   update differences for next step</span>

<span class="w">      </span><span class="k">do </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">neqn</span>
<span class="w">        </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">kp1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yp</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">kp2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">kp1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">kp2</span><span class="p">)</span>
<span class="w">      </span><span class="k">end do</span>
<span class="k">      do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>
<span class="w">        </span><span class="k">do </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">neqn</span>
<span class="w">          </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">kp1</span><span class="p">)</span>
<span class="w">        </span><span class="k">end do</span>
<span class="k">      end do</span>

<span class="c">!   estimate error at order k+1 unless:</span>
<span class="c">!     in first phase when always raise order,</span>
<span class="c">!     already decided to lower order,</span>
<span class="c">!     step size not constant so estimate unreliable</span>

<span class="w">      </span><span class="n">erkp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0_wp</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">knew</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">km1</span><span class="w">  </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w">  </span><span class="n">k</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="n">phase1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">phase1</span><span class="p">)</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mi">450</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">knew</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">km1</span><span class="p">)</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mi">455</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kp1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ns</span><span class="p">)</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mi">460</span>
<span class="w">      </span><span class="k">do </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">neqn</span>
<span class="w">        </span><span class="n">erkp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">erkp1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">phi</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">kp2</span><span class="p">)</span><span class="o">/</span><span class="n">wt</span><span class="p">(</span><span class="n">l</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
<span class="w">      </span><span class="k">end do</span>
<span class="k">      </span><span class="n">erkp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">absh</span><span class="o">*</span><span class="n">me</span><span class="p">%</span><span class="n">gstr</span><span class="p">(</span><span class="n">kp1</span><span class="p">)</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">erkp1</span><span class="p">)</span>

<span class="c">!   using estimated error at order k+1, determine appropriate order</span>
<span class="c">!   for next step</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">erkm1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">erk</span><span class="p">,</span><span class="n">erkp1</span><span class="p">))</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mi">455</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">erkp1</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">erk</span><span class="w">  </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w">  </span><span class="n">k</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mi">460</span>
<span class="w">      </span><span class="k">else</span>
<span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">erkp1</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.5_wp</span><span class="o">*</span><span class="n">erk</span><span class="p">)</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mi">460</span>
<span class="w">      </span><span class="k">end if</span>

<span class="c">!   here erkp1 &lt; erk &lt; max(erkm1,erkm2) else order would have</span>
<span class="c">!   been lowered in block 2.  thus order is to be raised</span>

<span class="c">!   raise order</span>

<span class="w"> </span><span class="mi">450</span><span class="w">  </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kp1</span>
<span class="w">      </span><span class="n">erk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">erkp1</span>
<span class="w">      </span><span class="k">go</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mi">460</span>

<span class="c">!   lower order</span>

<span class="w"> </span><span class="mi">455</span><span class="w">  </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">km1</span>
<span class="w">      </span><span class="n">erk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">erkm1</span>

<span class="w">      </span><span class="c">! with new order determine appropriate step size for next step</span>
<span class="w"> </span><span class="mi">460</span><span class="w">  </span><span class="n">hnew</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">phase1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">p5eps</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">erk</span><span class="o">*</span><span class="n">me</span><span class="p">%</span><span class="n">two</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">              </span><span class="n">hnew</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p5eps</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">erk</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  </span><span class="n">temp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
<span class="w">                  </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">p5eps</span><span class="o">/</span><span class="n">erk</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0_wp</span><span class="o">/</span><span class="n">temp2</span><span class="p">)</span>
<span class="w">                  </span><span class="n">hnew</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">absh</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.5_wp</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="mf">0.9_wp</span><span class="p">,</span><span class="n">r</span><span class="p">))</span>
<span class="w">                  </span><span class="n">hnew</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sign</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">hnew</span><span class="p">,</span><span class="n">fouru</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span><span class="n">h</span><span class="p">)</span>
<span class="w">              </span><span class="k">end if</span>
<span class="k">          end if</span>
<span class="k">      end if</span>
<span class="k">      </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hnew</span>
<span class="c">!       ***     end block 4     ***</span>

<span class="w">    </span><span class="k">end subroutine </span><span class="n">dsteps</span>
</pre></div>

    </section>
    <br>
    
    </div>
  </div>

      <hr>
    </div> <!-- /container -->
    <footer>
      <div class="container">
        <div class="row justify-content-between">
          <div class="col"><p>ddeabm was developed by Jacob Williams<br>&copy; 2024 
</p>
          </div>
          <div class="col">
            <p class="text-end">
              Documentation generated by
              <a href="https://github.com/Fortran-FOSS-Programmers/ford">FORD</a>
            </p>
          </div>
        </div>
        <br>
      </div> <!-- /container -->
    </footer>

    <!-- Bootstrap core JavaScript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>    

    <!-- MathJax JavaScript
             ================================================== -->
             <!-- Placed at the end of the document so the pages load faster -->
        <script type="text/x-mathjax-config">
          MathJax.Hub.Config({
          TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
          jax: ['input/TeX','input/MathML','output/HTML-CSS'],
          extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
          });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

          <script src="../tipuesearch/tipuesearch_content.js"></script>
          <script src="../tipuesearch/tipuesearch_set.js"></script>
          <script src="../tipuesearch/tipuesearch.js"></script>

  </body>
</html>